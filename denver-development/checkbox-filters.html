<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="robots" content="noindex,follow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Denver Residential Development | The Denver Post</title>
    <link rel="shortcut icon" href="//extras.mnginteractive.com/live/media/favIcon/dpo/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="//cdn.jsdelivr.net/foundation/6.2.4/foundation.min.css" />
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="" />
    <script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/foundation/6.2.4/foundation.min.js"></script>
    <script src="//extras.denverpost.com/foundation/js/vendor/modernizr.js"></script>
    <script src="//unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
    <script src="//extras.denverpost.com/app/homicide-report/js/leaflet-grouped-layer-control.js"></script>
    <script src="leaflet-ajax.js"></script>
    </script>
    <style>
        @import url('//fonts.googleapis.com/css?family=Roboto');

    html,
    body {
        height: 100%;
        width: 100%;
        padding: 0;
        background-color: #fafafa;
        font-family: 'Roboto', sans-serif;
        margin-top: 1%;
    }

    #container {
        height: 600px;
        width: 893px;
        margin: 0 auto;
    }

    #map {
        height: 600px;
        width: 100%;
        /*width: 893px;
        height: 600px;
        margin: 0 auto;*/
        border: 2px solid silver;
    }

    .leaflet-popup-content-wrapper {
        border-radius: 0;
        background-color: #fafafa;
        /*max-width: 200px;*/
        line-height: 100%;
    }

    .leaflet-container {
        font-family: 'Roboto', sans-serif;
    }

    .leaflet-popup-content {
        font-size: 1.2em;
        letter-spacing: .2px;
    }

    /*#content-container {
        padding: 15px;
    }*/
    .legend-text {
        text-transform: uppercase;
        font-size: .9rem;
        font-weight: bold;
        color: #737373;
        text-align: center;
        margin-bottom: 3px;
    }

    h2 {
        font-family: 'Roboto', sans-serif;
        font-size: 2em;
        font-weight: 700;
        letter-spacing: 0px;
        line-height: 100%
    }

    .neighborhood {
        font-size: 1.4em;
        font-weight: 700;
        margin-bottom: -19px;
    }

    .address {
        font-style: italic;
        color: rgba(0, 0, 0, .8);
    }

    .popup-text {
        margin-bottom: -17px !important;
        color: rgba(0, 0, 0, .8);
    }

    .popup-header {
        font-weight: 700;
        font-size: 1.1em;
        /*letter-spacing: .5px;*/
        /*text-transform: uppercase;*/
        color: #000;
        margin-bottom: 0;
    }

    hr {
        margin: -12px 0 -8px 0;
    }

    .note {
        font-size: .85em;
        font-style: italic;
    }

    .source {
        font-size: .9em;
        font-style: italic;
        text-align: right;
    }

    .legend {
        width: 60px;
        height: 30px;
        opacity: .6;
        float: left;
    }

    .legend-text {
        font-size: .7em;
        font-weight: bold;
        text-align: center;
        margin-top: 7px;
        letter-spacing: 1px;
        line-height: 22px;
    }

    input.leaflet-control-layers-selector {
        margin: 0;
    }

    label {
        line-height: 1.45;
    }

    .icon-2018 {
        border-radius: 50%;
        border: 2px solid rgba(0, 0, 0, .5);
        background: #ca0020;
    }

    .icon-2017 {
        border-radius: 50%;
        border: 2px solid rgba(0, 0, 0, .5);
        background: #f4a582;
    }

    .icon-2016 {
        border-radius: 50%;
        border: 2px solid rgba(0, 0, 0, .5);
        background: #f7f7f7;
    }

    .icon-2015 {
        border-radius: 50%;
        border: 2px solid rgba(0, 0, 0, .5);
        background: #92c5de;
    }

    .icon-2014 {
        border-radius: 50%;
        border: 2px solid rgba(0, 0, 0, .5);
        background: #0571b0;
    }

    .selector-2018,
    .selector-2017,
    .selector-2016,
    .selector-2015,
    .selector-2014 {
        height: 12px;
        width: 12px;
        display: inline-block;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, .5);
        margin: 0 0 0 3px;
    }

    .selector-2018 {
        background: #ca0020;
    }

    .selector-2017 {
        background: #f4a582;
    }

    .selector-2016 {
        background: #f7f7f7;
    }

    .selector-2015 {
        background: #92c5de;
    }

    .selector-2014 {
        background: #0571b0;
    }

    a.leaflet-control-layers-toggle {
        background-color: red;
    }
    </style>
</head>

<body>
    <div id="container">
        <h2>Title and title and title</h2>
        <p>Chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter and chatter. <strong><em>Zoom and click map markers for details. Neighborhood boundaries are shown in gray &mdash; click for name.</em></strong></p>
        <div style="margin-bottom:15px;" class="legend-text">
            <span style="border-top: 3px solid #ccc">Single family dwelling</span> &bull; <span style="border-top: 3px solid #4f9da6">Two family dwelling</span> &bull; <span style="border-top: 3px solid #ffad5a">Townhome</span> &bull; <span style="border-top: 3px solid #ff5959" id="layerApartments">Apartments/condos</span> &bull; <span style="border-top: 3px solid #1a0841">Multi-use w/residential</span>
        </div>
        <div class="button-group">
            <button type="button" id="allPermits" class="button">Reset filters</button>
            <button type="button" id="layer2018" class="button">2018</button>
            <button type="button" id="layer2017" class="button">2017</button>
            <button type="button" id="layer2016" class="button">2016</button>
        </div>
        <div id="map"></div>
        <p class="source">By Kevin Hamm, The Denver Post &bull; Source: Source?</p>
        <p class="note">Note: Some map markers may overlap.</p>
        <div class="inputs" id="event-types">
            <input type="checkbox" class="event-type" name="one-family" value="001 - One Family Dwellings, detached" checked="true">
            <label for="one-family">One family</label>
            <input type="checkbox" class="event-type" name="two-family" value="002 - Two Family Dwellings" checked="true">
            <label for="two-family">Two family</label>
            <input type="checkbox" class="event-type" name="townhome" value="023 - One family attached (Townhome 3 + units)" checked="true">
            <label for="townhome">Townhome</label>
            <input type="checkbox" class="event-type" name="apartment" value="024 - Multi-unit structure on one parcel (Apts/Condos)> 2 units" checked="true">
            <label for="apartment">Apartments</label>
            <input type="checkbox" class="event-type" name="mixed-use" value="025 - New mixed use with residential (any non-residential building containing living units)" checked="true">
            <label for="mixed-use">Mixed use</label>
        </div>
        <div class="inputs" id="years">
            <input type="checkbox" class="year" name="2016" value="2016" checked="true">
            <label for="2016">2016</label>
            <input type="checkbox" class="year" name="2017" value="2017" checked="true">
            <label for="2017">2017</label>
            <input type="checkbox" class="year" name="2018" value="2018" checked="true">
            <label for="2018">2018</label>
            <input type="checkbox" class="year" name="2019" value="2019" checked="true">
            <label for="2019">2019</label>
        </div>
    </div>
    <script src="denver-permits.js"></script>
    <script>
        // From https://gis.stackexchange.com/questions/307985/multiple-on-the-fly-filtering-based-on-markers-features-on-leaflet

    let checkboxStates

  //   const jsontest = {
  // "type": "FeatureCollection",
  // "features": [
  //   {
  //     "type": "Feature",
  //     "geometry": {
  //       "type": "Point",
  //       "coordinates": [
  //         -104.9992,
  //         39.76867
  //       ]
  //     },
  //     "properties": {
  //       "dwellingType": "Multi",
  //       "recordID": "2015-RESCON-0001818",
  //       "dateIssued": "1/4/2016",
  //       "permitType": "Residential Construction",
  //       "permitValuation": "184900",
  //       "units": "1",
  //       "address": "3728 N Jason St",
  //       "contractor": "Gallup Development LLC",
  //       "statCode": "002 - Two Family Dwellings",
  //       "neighborhood": "Highland",
  //       "postal": "80211",
  //       "confidence": "9"
  //     }
  //   },
  //   {
  //     "type": "Feature",
  //     "geometry": {
  //       "type": "Point",
  //       "coordinates": [
  //         -104.9992,
  //         39.76848
  //       ]
  //     },
  //     "properties": {
  //       "dwellingType": "Multi",
  //       "recordID": "2015-RESCON-0001810",
  //       "dateIssued": "1/4/2016",
  //       "permitType": "Residential Construction",
  //       "permitValuation": "184900",
  //       "units": "1",
  //       "address": "3722 N Jason St",
  //       "contractor": "Gallup Development LLC",
  //       "statCode": "002 - Two Family Dwellings",
  //       "neighborhood": "Highland",
  //       "postal": "80211",
  //       "confidence": "9"
  //     }
  //   }
  //   ]};

    var cartoTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    });
    // var map = L.map('map')
    //     .addLayer(cartoTiles)
    //     .setView([42.444508, -76.499491], 12);

    var map = L.map('map', {
        center: [39.7392, -104.9903],
        zoom: 13,
        minZoom: 11,
        preferCanvas: true
        //layers: [streetMap, neighborhoods, homicides2018, homicides2017, homicides2016, homicides2015, homicides2014]
    }).addLayer(cartoTiles);

    const geojsonLayer = L.geoJSON(null, {
        filter: (feature) => {
            // var allYears = (new Date(feature.properties.dateIssued)).getFullYear();
            // console.log(allYears);

            const isYearChecked = checkboxStates.years.includes(new Date(parseInt(feature.properties.dateIssued).substr))
            // console.log(checkboxStates.years);
            const isEventTypeChecked = checkboxStates.eventTypes.includes(feature.properties.statCode)
            return isYearChecked && isEventTypeChecked //only true if both are true
        },
            pointToLayer: function(feature, latlng) {
                var circleRadius;
                if (feature.properties.units > 10) {
                    circleRadius = Math.sqrt(feature.properties.units)
                } else {
                    circleRadius = 3
                };
                var oneFamilyDetached = {
                    radius: circleRadius,
                    fillColor: "gray",
                    color: "#aaa",
                    weight: 0,
                    opacity: 0,
                    fillOpacity: .6
                };
                var twoFamily = {
                    radius: circleRadius,
                    fillColor: "#4f9da6",
                    color: "#aaa",
                    weight: 0,
                    opacity: 0,
                    fillOpacity: .6
                };
                var oneFamilyAttached = {
                    radius: circleRadius,
                    fillColor: "#ffad5a",
                    color: "#aaa",
                    weight: 0,
                    opacity: 0,
                    fillOpacity: .6
                };
                var multiUnit = {
                    radius: circleRadius,
                    fillColor: "#ff5959",
                    color: "#aaa",
                    weight: 0,
                    opacity: 0,
                    fillOpacity: .6
                };
                var mixedUse = {
                    radius: circleRadius,
                    fillColor: "#1a0841",
                    color: "#aaa",
                    weight: 0,
                    opacity: 0,
                    fillOpacity: .6
                };
                var permitValueFormat = feature.properties.permitValuation;
                function numberWithCommas(permitValueFormat) {
                    return permitValueFormat.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }
                var dwellingDesc;
                if (feature.properties.statCode == '001 - One Family Dwellings, detached') {
                    dwellingDesc = 'Single family dwelling'
                } else if (feature.properties.statCode == '002 - Two Family Dwellings') {
                    dwellingDesc = 'Two family dwelling'
                } else if (feature.properties.statCode == '023 - One family attached (Townhome 3 + units)') {
                    dwellingDesc = 'Townhome'
                } else if (feature.properties.statCode == '024 - Multi-unit structure on one parcel (Apts/Condos)> 2 units') {
                    dwellingDesc = 'Apartments/condos'
                } else {
                    dwellingDesc = 'Mixed use w/ residential'
                }
                // var sunnyside = 'Sunnyside';
                // if (feature.properties.neighborhood === 'Sunny Side') {
                //     return sunnyside
                // } else {
                //     return feature.properties.neighborhood
                // }
                var tooltipText = '<h4 class="neighborhood">' + feature.properties.neighborhood + ' &bull; ' + feature.properties.units + ' unit(s)</h4><p class="address">' + feature.properties.address + ' &bull; ' + dwellingDesc + '</p><hr><p class="popup-text">Permit issued: <strong>' + feature.properties.dateIssued + '</strong></p><p class="popup-text">Permit valuation: <strong>$' + numberWithCommas(permitValueFormat) + '</strong></p><p class=popup-text">Contractor: <strong>' + feature.properties.contractor + '</strong></p>'
                if (feature.properties.statCode == '001 - One Family Dwellings, detached') {
                    return L.circleMarker(latlng, oneFamilyDetached).bindPopup(tooltipText)
                } else if (feature.properties.statCode == '002 - Two Family Dwellings') {
                    return L.circleMarker(latlng, twoFamily).bindPopup(tooltipText)
                } else if (feature.properties.statCode == '023 - One family attached (Townhome 3 + units)') {
                    return L.circleMarker(latlng, oneFamilyAttached).bindPopup(tooltipText)
                } else if (feature.properties.statCode == '024 - Multi-unit structure on one parcel (Apts/Condos)> 2 units') {
                    return L.circleMarker(latlng, multiUnit).bindPopup(tooltipText)
                } else {
                    return L.circleMarker(latlng, mixedUse).bindPopup(tooltipText)
                }
            }
    }).addTo(map)

    function updateCheckboxStates() {
        checkboxStates = {
            years: [],
            eventTypes: []
        }

        for (let input of document.querySelectorAll('input')) {
            if (input.checked) {
                switch (input.className) {
                    case 'event-type':
                        checkboxStates.eventTypes.push(input.value);
                        break
                    case 'year':
                        checkboxStates.years.push(input.value);
                        break
                }
            }
        }
    }


    for (let input of document.querySelectorAll('input')) {
        //Listen to 'change' event of all inputs
        input.onchange = (e) => {
            geojsonLayer.clearLayers()
            updateCheckboxStates()
            geojsonLayer.addData(jsontest)
        }
    }


    /****** INIT ******/
    updateCheckboxStates()
    geojsonLayer.addData(jsontest)
    </script>
</body>

</html>